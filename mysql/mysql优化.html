<h1 id="mysql优化">MySQL优化</h1>

<p><div class="toc">
<ul>
<li><a href="#mysql优化">MySQL优化</a><ul>
<li><a href="#1定位慢查询">1,定位慢查询</a><ul>
<li><a href="#mysql命令">MySQL命令</a></li>
<li><a href="#定位慢查询">定位慢查询</a></li>
<li><a href="#索引">索引</a></li>
<li><a href="#explain分析sql语句">explain分析SQL语句</a></li>
<li><a href="#选择mysql存储引擎">选择MySQL存储引擎</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</p>



<h2 id="1定位慢查询">1,定位慢查询</h2>

<p>增、删、改10%，查询90%</p>

<blockquote>
  <p><strong>数据库引擎</strong></p>
  
  <ul>
  <li><strong>MyISAM</strong>：不支持事务，用于只读程序提高性能</li>
  <li><strong>InnoDB</strong>：支持ACID事务、行级锁、并发</li>
  <li>Berkeley DB：支持事务</li>
  </ul>
</blockquote>

<pre><code>//设置命令结束符
DELIMITER $$

//创建表
CREATE TABLE emp
(
    empno MEDIUMINT UNSIGNED NOT NULL DEFAULT 0,
    ename VARCHAR(20) NOT NULL DEFAULT '',
    job VARCHAR(9) NOT NULL DEFAULT '',
    mgr MEDIUMINT UNSIGNED NOT NULL DEFAULT 0,
    hiredate DATETIME NOT NULL,
    sal DECIMAL(7,2) NOT NULL,
    comm DECIMAL(7,2) NOT NULL,
    deptno MEDIUMINT UNSIGNED NOT NULL DEFAULT 0
)ENGINE=MYISAM DEFAULT CHARSET=utf8;

//获取随机字符串的存储函数
CREATE FUNCTION rand_string(len INT) 
RETURNS VARCHAR(255)
BEGIN
    DECLARE char_str VARCHAR(100);
    DECLARE return_str VARCHAR(255);
    DECLARE i INT;
    SET char_str = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    SET return_str = '';
    SET i = 0;
    WHILE i &lt; len DO
    SET return_str = CONCAT(return_str, SUBSTRING(char_str, FLOOR(1+RAND()*62), 1));
    SET i = i + 1;
    END WHILE;
    RETURN return_str;
END

//获取随机4位整数的存储函数
CREATE FUNCTION rand_int()
RETURNS INT(4)
BEGIN
    DECLARE i INT DEFAULT 0;
    SET i = FLOOR(1 + RAND() * 10000);
    RETURN i;
END$$

//批量插入数据的存储过程
CREATE PROCEDURE insert_emp(IN _start INT(10), IN _max_num INT(10))
BEGIN
    DECLARE i INT DEFAULT 0;
    SET i = 0;
    SET autocommit=0; //设置事务不自动提交，但如果是MyISAM（不支持事务）数据库则无效。
    WHILE i &lt; _max_num DO
    SET i = i + 1;
    INSERT INTO emp VALUES(_start + i, rand_string(6), 'salesman', 0001, CURDATE(), 2000, 400, rand_int());
    END WHILE;
    COMMIT;
END$$

//调用存储过程插入5000000条数据
call insert_emp(1, 5000000)$$
</code></pre>



<h3 id="mysql命令">MySQL命令</h3>

<table>
<thead>
<tr>
  <th align="left">SQL命令</th>
  <th align="left">含义</th>
</tr>
</thead>
<tbody><tr>
  <td align="left">show [session | global] status like ‘com_insert%’</td>
  <td align="left">显示执行了多少条insert语句</td>
</tr>
<tr>
  <td align="left">show [session | global] status like ‘com_select%’</td>
  <td align="left">显示执行了多少条select语句</td>
</tr>
<tr>
  <td align="left">show status like ‘uptime’</td>
  <td align="left">显示数据库启动多长时间了</td>
</tr>
<tr>
  <td align="left">show [session | global] status like ‘slow_queries’</td>
  <td align="left">显示慢查询（默认情况下大于10s是慢查询）</td>
</tr>
<tr>
  <td align="left">show [session | global] variables like ‘long_query_time’</td>
  <td align="left">显示慢查询的时间，默认10s</td>
</tr>
<tr>
  <td align="left">SET [session | global] long_query_time=0.5;</td>
  <td align="left">设置慢查询时间为0.5s （注意，session关闭后会恢复到之前的默认值）</td>
</tr>
</tbody></table>




<h3 id="定位慢查询">定位慢查询</h3>

<p>开启慢查询日志，一旦开启后，日志文件的位置在my.ini中找<kbd>datadir</kbd>，默认情况下是不会记录慢查询的。</p>

<blockquote>
  <p>1，关闭当前MySQL服务 <br>
            net stop mysql</p>
  
  <p>2，启动MySQL并开启慢查询<a href="#fn:startup" id="fnref:startup" title="See footnote" class="footnote">1</a> <br>
            mysqld –defaults-file=my.ini  –long_query_time=0.5  –slow-query-log –log-output=FILE</p>
  
  <p>3, 关闭安全模式 <br>
           mysqladmin -uroot -p** shut down</p>
</blockquote>

<p>或者，如果不想重启数据库，可以在MySQL中执行以下命令，但是对旧的session无效，对新的session才有效。</p>

<blockquote>
  <p>SET GLOBAL long_query_time=0.5; <br>
  SET GLOBAL slow_query_log=’ON’; <br>
  SET GLOBAL log_output=’FILE’; <br>
  SET GLOBAL log_slow_admin_statements=’ON’;</p>
</blockquote>



<h3 id="索引">索引</h3>

<blockquote>
  <p>1，创建索引 <br>
        create index 索引名 on 表名 (字段名);</p>
  
  <p>2，查看索引 <br>
        show indexes from 表名;</p>
  
  <p>3，全文索引 <br>
  create table article ( <br>
  title varchar(200),  <br>
  body TEXT,  <br>
  <strong>FULLTEXT</strong>(title, body)  <br>
  ) engine=MyISAM charset=utf8;</p>
  
  <p>查询全文索引 <br>
  select * from article where match(title, body) against(‘keywords’);</p>
  
  <p>查看匹配相关度 <br>
  select match(title, body) against(‘keywords’) from article;</p>
  
  <p><strong>Note: </strong>  <br>
  FULLTEXT类型只在MyISAM引擎中有，InnoDB中没有，MySQL默认使用InnoDB <br>
  匹配度超过%50（一半的表数据）的关键字，是不会做全文索引的，这个查询关键字keywords叫停止词（这个特点告诉我们，要做全文索引必须是海量数据） <br>
  FULLTEXT不支持中文，需要用<kbd>sphinx</kbd>技术去处理中文</p>
  
  <p>4，唯一索引 <br>
  create table stu( <br>
  stuid int primary key, <br>
  name varchar(10) <strong>unique</strong>, <br>
  email varchar(50));</p>
  
  <p>create <strong>unique</strong> index 索引名 on 表名 (字段名)</p>
  
  <p><strong>Note:</strong> <br>
  主键与唯一索引的区别： <br>
  主键索引不能重复、不能为空 <br>
  唯一索引不能重复、可以为空</p>
</blockquote>



<h3 id="explain分析sql语句">explain分析SQL语句</h3>

<blockquote>
  <p>explain select * from 表名 where 条件 \G; </p>
  
  <p>创建复合索引（按照字段1查询时索引被使用，按字段2查询时索引不会被使用） <br>
  alter table 表名 add index 索引名 (字段1, 字段2)</p>
  
  <p><strong>Note:</strong> <br>
  如果用主键去查询，自动会使用主键索引 <br>
  如果创建的是复合索引，只有左边的可以用，右边的不管用。（不要用组合索引） <br>
  在模糊查询时，如果like ‘%keywords’索引不被使用；like ‘keywords%’索引被使用 <br>
  在条件语句中使用or，or两边的字段都必须要有索引，有一个没有，索引就无法使用。 <br>
  如果字段是字符型的，查询时必须有”引起来，索引才能使用。</p>
</blockquote>



<h3 id="选择mysql存储引擎">选择MySQL存储引擎</h3>

<dl>
<dt><strong>MyISAM</strong></dt>
<dd>不支持事务处理</dd>

<dd>查询和添加效率高</dd>

<dd>碎片多</dd>

<dd>论坛

<blockquote>
  碎片整理 <br>
  optimize table 表名
</blockquote></dd>

<dt><strong>InnoDB</strong></dt>
<dd>支持事务</dd>

<dd>保存比较重要的信息</dd>

<dt><strong>Memory</strong></dt>
<dd>数据频繁更改，而且不需要在数据库中永久保存</dd>

<dd>Sesion入库</dd>
</dl>

<div class="footnotes"><hr><ol><li id="fn:startup">MySQL5.6启动参数 <br>
<a href="http://dev.mysql.com/doc/refman/5.6/en/server-options.html">http://dev.mysql.com/doc/refman/5.6/en/server-options.html</a> <br>
<a href="http://dev.mysql.com/doc/refman/5.6/en/log-destinations.html">http://dev.mysql.com/doc/refman/5.6/en/log-destinations.html</a> <br>
<a href="http://dev.mysql.com/doc/refman/5.6/en/mysqld-option-tables.html">http://dev.mysql.com/doc/refman/5.6/en/mysqld-option-tables.html</a> <a href="#fnref:startup" title="Return to article" class="reversefootnote">↩</a></li></ol></div>